{% extends "base.html" %}

{% block title %}Servicios y Puertos - ORION{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="header-content">
        <div>
            <h1 class="dashboard-title">Servicios y Puertos</h1>
            <p class="dashboard-subtitle">Monitoreo en tiempo real de servicios activos y puertos en uso</p>
        </div>
        <div class="header-actions">
            <a href="/" class="btn btn-secondary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z"/>
                </svg>
                Dashboard
            </a>
            <button class="btn btn-primary" onclick="refreshServices()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                    <path d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                </svg>
                Actualizar
            </button>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card stat-success">
        <div class="stat-icon">
            <svg fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
            </svg>
        </div>
        <h3>Servicios Activos</h3>
        <div class="stat-value status-online">{{ active_count }}</div>
        <div class="stat-label">en ejecución</div>
    </div>

    <div class="stat-card stat-info">
        <div class="stat-icon">
            <svg fill="currentColor" viewBox="0 0 16 16">
                <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5h-6a.5.5 0 0 1-.5-.5v-6z"/>
                <path d="M5.5 2A1.5 1.5 0 0 0 4 3.5v9A1.5 1.5 0 0 0 5.5 14h5a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 10.5 2h-5zM3 3.5A2.5 2.5 0 0 1 5.5 1h5A2.5 2.5 0 0 1 13 3.5v9a2.5 2.5 0 0 1-2.5 2.5h-5A2.5 2.5 0 0 1 3 12.5v-9z"/>
            </svg>
        </div>
        <h3>Puertos Escuchando</h3>
        <div class="stat-value">{{ ports_count }}</div>
        <div class="stat-label">puertos activos</div>
    </div>

    <div class="stat-card stat-warning">
        <div class="stat-icon">
            <svg fill="currentColor" viewBox="0 0 16 16">
                <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0zm-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3h-7zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
            </svg>
        </div>
        <h3>CPU</h3>
        <div class="stat-value">{{ "%.1f"|format(system_info.cpu.percent) }}%</div>
        <div class="stat-label">uso actual</div>
    </div>

    <div class="stat-card stat-primary">
        <div class="stat-icon">
            <svg fill="currentColor" viewBox="0 0 16 16">
                <path d="M1 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.586a1 1 0 0 0 .707-.293l.353-.353a.5.5 0 0 1 .708 0l.353.353a1 1 0 0 0 .707.293H13a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H9.414a1 1 0 0 0-.707.293l-.353.353a.5.5 0 0 1-.708 0L7.293 3.293A1 1 0 0 0 6.586 3H1z"/>
            </svg>
        </div>
        <h3>Memoria</h3>
        <div class="stat-value">{{ "%.1f"|format(system_info.memory.percent) }}%</div>
        <div class="stat-label">{{ "%.1f"|format(system_info.memory.used_gb) }}GB usado</div>
    </div>
</div>

<!-- Two Column Layout -->
<div class="services-layout">
    <!-- Active Services Section -->
    <div class="services-column">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 0.5rem;">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                    </svg>
                    Servicios Activos ({{ active_count }})
                </h2>
            </div>

            <div class="services-list">
                {% if active_services %}
                    {% for service in active_services %}
                    <div class="service-card service-active">
                        <div class="service-header">
                            <div class="service-title">
                                <div class="status-indicator status-online"></div>
                                <h3>{{ service.nombre }}</h3>
                            </div>
                            <span class="service-type-badge">{{ service.tipo or 'Python' }}</span>
                        </div>
                        <div class="service-metrics">
                            {% if service.puerto %}
                            <div class="metric">
                                <span class="metric-label">Puerto</span>
                                <span class="metric-value">{{ service.puerto }}</span>
                            </div>
                            {% endif %}
                            {% if service.pid %}
                            <div class="metric">
                                <span class="metric-label">PID</span>
                                <span class="metric-value">{{ service.pid }}</span>
                            </div>
                            {% endif %}
                            {% if service.cpu_percent is not none %}
                            <div class="metric">
                                <span class="metric-label">CPU</span>
                                <span class="metric-value">{{ "%.1f"|format(service.cpu_percent) }}%</span>
                            </div>
                            {% endif %}
                            {% if service.memory_mb is not none %}
                            <div class="metric">
                                <span class="metric-label">RAM</span>
                                <span class="metric-value">{{ "%.0f"|format(service.memory_mb) }}MB</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-service-state">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        </svg>
                        <p>No hay servicios activos</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ports Section -->
    <div class="services-column">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 0.5rem;">
                        <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5h-6a.5.5 0 0 1-.5-.5v-6z"/>
                        <path d="M5.5 2A1.5 1.5 0 0 0 4 3.5v9A1.5 1.5 0 0 0 5.5 14h5a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 10.5 2h-5zM3 3.5A2.5 2.5 0 0 1 5.5 1h5A2.5 2.5 0 0 1 13 3.5v9a2.5 2.5 0 0 1-2.5 2.5h-5A2.5 2.5 0 0 1 3 12.5v-9z"/>
                    </svg>
                    Puertos en Uso ({{ ports_count }})
                </h2>
            </div>

            <div class="ports-list">
                {% if listening_ports %}
                    {% for port in listening_ports[:20] %}
                    <div class="port-card">
                        <div class="port-header">
                            <div class="port-number">:{{ port.port }}</div>
                            <div class="port-address">{{ port.address }}</div>
                        </div>
                        <div class="port-details">
                            <div class="port-process">
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                                </svg>
                                <span class="process-name">{{ port.process }}</span>
                            </div>
                            {% if port.pid %}
                            <div class="port-pid">PID: {{ port.pid }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% if listening_ports|length > 20 %}
                    <div class="port-card port-more">
                        <p>Y {{ listening_ports|length - 20 }} puertos más...</p>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="empty-service-state">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5h-6a.5.5 0 0 1-.5-.5v-6z"/>
                        </svg>
                        <p>No hay puertos en escucha</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Inactive Services Section (Collapsed) -->
{% if inactive_services %}
<div class="section-container" style="margin-top: 2rem;">
    <details class="collapsible-section">
        <summary class="section-header-collapsible">
            <h2 class="section-title">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 0.5rem;">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                </svg>
                Servicios Inactivos ({{ inactive_services|length }})
            </h2>
        </summary>
        <div class="services-list" style="margin-top: 1rem;">
            {% for service in inactive_services %}
            <div class="service-card service-inactive">
                <div class="service-header">
                    <div class="service-title">
                        <div class="status-indicator status-offline"></div>
                        <h3>{{ service.nombre }}</h3>
                    </div>
                    <span class="service-type-badge inactive">{{ service.tipo or 'Python' }}</span>
                </div>
                <div class="service-path">{{ service.ruta }}</div>
            </div>
            {% endfor %}
        </div>
    </details>
</div>
{% endif %}

<style>
/* Services Layout */
.services-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 2rem;
}

.services-column {
    min-width: 0;
}

/* Service Cards */
.services-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.service-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.25rem;
    transition: all 0.2s ease;
    border-left: 4px solid var(--border-color);
}

.service-card.service-active {
    border-left-color: var(--success);
}

.service-card.service-inactive {
    border-left-color: var(--gray-400);
    opacity: 0.8;
}

.service-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.service-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.service-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.service-title h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-indicator.status-online {
    background: var(--success);
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.status-indicator.status-offline {
    background: var(--gray-400);
}

.service-type-badge {
    padding: 0.25rem 0.75rem;
    background: var(--background-alt);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.service-type-badge.inactive {
    opacity: 0.6;
}

.service-metrics {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.metric {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.metric-label {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

.metric-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
}

.service-path {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: var(--background-alt);
    border-radius: 4px;
}

/* Port Cards */
.ports-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.port-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.2s ease;
}

.port-card:hover {
    box-shadow: var(--shadow-sm);
    border-color: var(--gray-300);
}

.port-card.port-more {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-style: italic;
}

.port-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.port-number {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
}

.port-address {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
    padding: 0.25rem 0.5rem;
    background: var(--background-alt);
    border-radius: 4px;
}

.port-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.port-process {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.process-name {
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
}

.port-pid {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
}

/* Empty State */
.empty-service-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-secondary);
}

.empty-service-state svg {
    margin-bottom: 1rem;
    color: var(--gray-400);
}

.empty-service-state p {
    font-size: 0.9rem;
}

/* Collapsible Section */
.collapsible-section {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.5rem;
}

.section-header-collapsible {
    cursor: pointer;
    list-style: none;
    user-select: none;
}

.section-header-collapsible::-webkit-details-marker {
    display: none;
}

.section-header-collapsible::before {
    content: '▶';
    display: inline-block;
    margin-right: 0.5rem;
    transition: transform 0.2s ease;
    font-size: 0.75rem;
}

details[open] .section-header-collapsible::before {
    transform: rotate(90deg);
}

/* Responsive */
@media (max-width: 1024px) {
    .services-layout {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .service-metrics {
        gap: 1rem;
    }

    .metric {
        flex: 1 1 calc(50% - 0.5rem);
    }
}
</style>

<script>
function refreshServices() {
    location.reload();
}
</script>

{% endblock %}
